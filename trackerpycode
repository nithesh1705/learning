import os
import datetime
import time
import schedule
import platform
from plyer import notification
from openpyxl import Workbook, load_workbook
from threading import Thread

# File paths
TRACKER_FILE = "daily_task_tracker.xlsx"

# --- Ensure Excel Tracker Exists ---
if not os.path.exists(TRACKER_FILE):
    wb = Workbook()
    ws = wb.active
    ws.title = "TaskTracker"
    ws.append(["Date", "Tasks"])
    wb.save(TRACKER_FILE)

# --- Sound Function ---
def play_beep():
    if platform.system() == "Windows":
        import winsound
        winsound.MessageBeep()
    else:
        print('\a')  # Bell for macOS/Linux

# --- Excel Functions ---
def get_tasks_for_date(date_str):
    wb = load_workbook(TRACKER_FILE)
    ws = wb.active
    for row in ws.iter_rows(min_row=2, values_only=True):
        if row[0] == date_str:
            return row[1].split(', ') if row[1] else []
    return []

def update_excel_tasks(date_str, task_list):
    wb = load_workbook(TRACKER_FILE)
    ws = wb.active
    for row in ws.iter_rows(min_row=2):
        if row[0].value == date_str:
            row[1].value = ', '.join(task_list)
            wb.save(TRACKER_FILE)
            return
    ws.append([date_str, ', '.join(task_list)])
    wb.save(TRACKER_FILE)

# --- Task Functions ---
def add_task(task):
    today = datetime.date.today().isoformat()
    tasks = get_tasks_for_date(today)
    tasks.append(task)
    update_excel_tasks(today, tasks)
    print(f"‚úÖ Task '{task}' added.")

def remove_task():
    today = datetime.date.today().isoformat()
    tasks = get_tasks_for_date(today)
    if not tasks:
        print("üì≠ No tasks to remove.")
        return

    print("\nüóëÔ∏è Choose a task to remove:")
    for i, t in enumerate(tasks, 1):
        print(f"{i}. {t}")

    try:
        choice = int(input("Enter task number: "))
        if 1 <= choice <= len(tasks):
            removed_task = tasks.pop(choice - 1)
            update_excel_tasks(today, tasks)
            print(f"‚ùå Task '{removed_task}' removed.")
        else:
            print("‚ö†Ô∏è Invalid choice.")
    except ValueError:
        print("‚ö†Ô∏è Invalid input.")

def mark_task_complete():
    today = datetime.date.today().isoformat()
    tasks = get_tasks_for_date(today)
    if not tasks:
        print("üì≠ No tasks to mark as complete.")
        return

    print("\n‚úÖ Choose a task to mark as completed:")
    for i, t in enumerate(tasks, 1):
        print(f"{i}. {t}")

    try:
        choice = int(input("Enter task number: "))
        if 1 <= choice <= len(tasks):
            print(f"‚úÖ Task '{tasks[choice - 1]}' marked as completed.")  # Not saving status yet
        else:
            print("‚ö†Ô∏è Invalid choice.")
    except ValueError:
        print("‚ö†Ô∏è Invalid input.")

def show_tasks_for_date(date_str):
    tasks = get_tasks_for_date(date_str)
    if tasks:
        print(f"\nüìÖ Tasks for {date_str}:")
        for t in tasks:
            print(f" - {t}")
    else:
        print(f"‚ùå No tasks found for {date_str}.")

def show_todays_tasks():
    today = datetime.date.today().isoformat()
    show_tasks_for_date(today)

# --- Notification ---
def notify_tasks():
    today = datetime.date.today().isoformat()
    tasks = get_tasks_for_date(today)
    if tasks:
        task_str = "\n".join([f"- {t}" for t in tasks])
        notification.notify(
            title="üìù Your Tasks for Today",
            message=task_str,
            timeout=10
        )
        play_beep()
    else:
        print("üì≠ No tasks to notify.")

# --- Menu UI ---
def menu():
    while True:
        print("\nüõ†Ô∏è Task Assistant Menu:")
        print("1. Add Task")
        print("2. Remove Task")
        print("3. Mark Task as Completed")
        print("4. Show Tasks for a Specific Date")
        print("5. Show Today's Tasks")
        print("6. Exit")

        choice = input("Choose an option: ")

        if choice == '1':
            task = input("Enter the task: ")
            add_task(task)
        elif choice == '2':
            remove_task()
        elif choice == '3':
            mark_task_complete()
        elif choice == '4':
            date_str = input("Enter the date (YYYY-MM-DD): ")
            show_tasks_for_date(date_str)
        elif choice == '5':
            show_todays_tasks()
        elif choice == '6':
            print("üëã Exiting Assistant...")
            break
        else:
            print("‚ùå Invalid choice. Try again.")

# --- Scheduler Setup ---
schedule.every().hour.do(notify_tasks)

# --- Start ---
if __name__ == "__main__":
    print("üìò Daily Task Assistant is Running...")

    # Run menu in separate thread
    menu_thread = Thread(target=menu)
    menu_thread.start()

    # Main loop for scheduled tasks
    while True:
        schedule.run_pending()
        time.sleep(1)
